          AREA |C$$code|, CODE, READONLY

; constants
width             * 64
height            * 64
period            * 3
wordsperrow       * 4
nwords            * 1660
nframes           * 9
active_x          * 32
active_y          * 32

; Workspace for changing the hourglass rendition
                  ^ 0, r12
hg_framenum       # 4                         ; frame number
hg_percentage     # 4                         ; percentage to show (N/I)
hg_leds           # 4                         ; LED flags (N/I)
hg_oldpointer     # 4                         ; Old pointer configuration
hg_oldcolours     # 4 * 3                     ; Old palette entries
hg_word           # 12                        ; OS_Word block
hg_currentdata    # 4 * wordsperrow * height  ; Current data for the hourglass
hg_workspacesize  * :INDEX: @                 ; Size of this workspace

; SWI numbers
XOS_Byte          * 0x20006
XOS_Word          * 0x20007
XOS_ReadPalette   * 0x2002F

; -------------------------------------------------
        MACRO
$label  SIGNATURE
        ALIGN   4
        =       "$label",0
        ALIGN   4
        DCD     &FF000000+(:LEN:"$label"+4):AND::NOT:3
$label
        MEND


; Data for deltas between frames
deltas
          ; frame 0
          DCD     &00000000, &00000000, &00000000, &00000000, &00000000
          DCD     &00000010, &00000000, &aa000000, &000000aa, &00000000
          DCD     &00000020, &00000000, &55800000, &00000255, &00000000
          DCD     &00000030, &00000000, &55600000, &00000255, &00000000
          DCD     &00000040, &00000000, &55600000, &00000255, &00000000
          DCD     &00000050, &00000000, &55600000, &00000255, &00000000
          DCD     &00000060, &00000000, &55600000, &00000255, &00000000
          DCD     &00000070, &08000000, &55600000, &00000955, &00000008
          DCD     &00000080, &a6000000, &55580000, &80000955, &00000026
          DCD     &00000090, &55800000, &55580002, &60000955, &00000095
          DCD     &000000a0, &55600000, &55580029, &58000955, &00000255
          DCD     &000000b0, &55580000, &55580095, &56800955, &00000955
          DCD     &000000c0, &55560000, &55568a55, &5560a555, &00002555
          DCD     &000000d0, &55558000, &55556555, &555a5555, &00009555
          DCD     &000000e0, &55560000, &55555555, &55555555, &00009555
          DCD     &000000f0, &55560000, &55555555, &55555555, &00002555
          DCD     &00000100, &55580000, &55555555, &55555555, &00000955
          DCD     &00000110, &55600000, &55555555, &55555555, &00000955
          DCD     &00000120, &55600000, &55555555, &55555555, &00000255
          DCD     &00000130, &55800000, &95555555, &55555555, &00000095
          DCD     &00000140, &56000000, &29555555, &5555556a, &00000095
          DCD     &00000150, &56000000, &02a55555, &55555680, &00000025
          DCD     &00000160, &58000000, &000a5555, &55556800, &00000025
          DCD     &00000170, &56000000, &00009555, &55568000, &00000025
          DCD     &00000180, &56000000, &00002555, &55560000, &00000025
          DCD     &00000190, &55aa0000, &00002555, &55580000, &00002a95
          DCD     &000001a0, &5555aa80, &00000955, &55580000, &00aa9555
          DCD     &000001b0, &55555560, &00000955, &55580000, &02555555
          DCD     &000001c0, &55555558, &00000955, &55600000, &09555555
          DCD     &000001d0, &55555558, &00000255, &55600000, &09555555
          DCD     &000001e0, &55555558, &00000255, &55800000, &09555555
          DCD     &000001f0, &55555558, &00000095, &55800000, &09555555
          DCD     &00000200, &55555558, &00000255, &55800000, &09555555
          DCD     &00000210, &55555558, &00000255, &55600000, &09555555
          DCD     &00000220, &55555558, &00000255, &55600000, &09555555
          DCD     &00000230, &55555558, &00000955, &55600000, &09555555
          DCD     &00000240, &55556aa0, &00000955, &55580000, &02a95555
          DCD     &00000250, &55aa8000, &00002555, &55580000, &0002aa95
          DCD     &00000260, &56000000, &00002555, &55560000, &00000095
          DCD     &00000270, &56000000, &00009555, &55560000, &00000025
          DCD     &00000280, &58000000, &00029555, &5555a000, &00000025
          DCD     &00000290, &58000000, &00a95555, &55555a00, &00000025
          DCD     &000002a0, &56000000, &0a555555, &555555a8, &00000025
          DCD     &000002b0, &55800000, &a5555555, &55555556, &00000095
          DCD     &000002c0, &55800000, &55555555, &55555555, &00000255
          DCD     &000002d0, &55600000, &55555555, &55555555, &00000255
          DCD     &000002e0, &55580000, &55555555, &55555555, &00000955
          DCD     &000002f0, &55580000, &55555555, &55555555, &00002555
          DCD     &00000300, &55560000, &55555555, &55555555, &00009555
          DCD     &00000310, &55558000, &55555555, &55555555, &00009555
          DCD     &00000320, &55560000, &5556a955, &556a9555, &00009555
          DCD     &00000330, &55580000, &55580295, &55802955, &00002555
          DCD     &00000340, &55580000, &55580025, &5a000955, &00000955
          DCD     &00000350, &55a00000, &5558000a, &60000955, &00000255
          DCD     &00000360, &96000000, &55580000, &80000955, &00000095
          DCD     &00000370, &28000000, &55600000, &00000955, &0000002a
          DCD     &00000380, &00000000, &55600000, &00000955, &00000000
          DCD     &00000390, &00000000, &55600000, &00000255, &00000000
          DCD     &000003a0, &00000000, &55600000, &00000255, &00000000
          DCD     &000003b0, &00000000, &55600000, &00000255, &00000000
          DCD     &000003c0, &00000000, &55800000, &00000255, &00000000
          DCD     &000003d0, &00000000, &aa000000, &000000aa, &00000000
          DCD     &000003e0, &00000000, &00000000, &00000000, &00000000
          DCD     &000003f0, &00000000, &00000000, &00000000, &00000000
          DCD     -1
          ; frame 1
          DCD     &00000010, &00000000, &a0000000, &00000aaa, &00000000
          DCD     &00000020, &00000000, &58000000, &00002555, &00000000
          DCD     &00000030, &00000000, &58000000, &00002555, &00000000
          DCD     &00000040, &00000000, &58000000, &00002555, &00000000
          DCD     &00000050, &00000000, &56000000, &00009555, &00000000
          DCD     &00000060, &a0000000, &56000002, &00009555, &00000000
          DCD     &00000070, &58000000, &56000009, &00009555, &00000000
          DCD     &00000080, &56000000, &55800025, &00009555, &00000000
          DCD     &00000090, &55800000, &55800295, &00009555, &000002a0
          DCD     &000000a0, &55600000, &55800955, &00009555, &0000095a
          DCD     &000000b0, &55580000, &55a82555, &80009555, &00000955
          DCD     &000000c0, &55580000, &55569555, &68009555, &00002555
          DCD     &000000d0, &55600000, &55555555, &568a5555, &00009555
          DCD     &000000e0, &55600000, &55555555, &55655555, &00025555
          DCD     &000000f0, &55800000, &55555555, &55555555, &00095555
          DCD     &00000100, &55800000, &55555555, &55555555, &00025555
          DCD     &00000110, &56000000, &55555555, &55555555, &00009555
          DCD     &00000120, &58000000, &55555555, &55555555, &00009555
          DCD     &00000130, &58000000, &55555555, &55555556, &00002555
          DCD     &00000140, &60000000, &a9555555, &55555568, &00000955
          DCD     &00000150, &58000000, &02a55555, &55555680, &00000255
          DCD     &00000160, &58000000, &000a5555, &55556800, &00000095
          DCD     &00000170, &56a80000, &00009555, &55568000, &00000095
          DCD     &00000180, &5556aa80, &00002555, &55560000, &00000095
          DCD     &00000190, &55555560, &00002555, &55580000, &00000095
          DCD     &000001a0, &55555558, &00000955, &55580000, &00000095
          DCD     &000001b0, &55555558, &00000955, &55580000, &00002a55
          DCD     &000001c0, &55555558, &00000255, &55600000, &002a9555
          DCD     &000001d0, &55555558, &00000255, &55600000, &02955555
          DCD     &000001e0, &55555558, &00000095, &55600000, &09555555
          DCD     &000001f0, &55555558, &00000255, &55800000, &09555555
          DCD     &00000210, &555555a0, &00000255, &55800000, &09555555
          DCD     &00000220, &55556a00, &00000955, &55600000, &09555555
          DCD     &00000230, &556a8000, &00000955, &55600000, &09555555
          DCD     &00000240, &55800000, &00000955, &55580000, &09555555
          DCD     &00000250, &55800000, &00002555, &55580000, &09555555
          DCD     &00000260, &56000000, &00002555, &55560000, &02a95555
          DCD     &00000270, &56000000, &0000a555, &55560000, &0002aaa5
          DCD     &00000280, &55800000, &000a5555, &55558000, &00000025
          DCD     &00000290, &55600000, &00a55555, &55556a80, &00000009
          DCD     &000002a0, &55600000, &0a555555, &5555556a, &00000009
          DCD     &000002b0, &55580000, &a5555555, &55555555, &00000009
          DCD     &000002c0, &55560000, &55555555, &55555555, &00000025
          DCD     &000002d0, &55558000, &55555555, &55555555, &00000025
          DCD     &000002e0, &55556000, &55555555, &55555555, &00000095
          DCD     &000002f0, &55556000, &55555555, &55555555, &00000095
          DCD     &00000300, &55556000, &55555555, &55555555, &00000255
          DCD     &00000310, &55558000, &55555a95, &55555555, &00000255
          DCD     &00000320, &55560000, &5555a029, &55559555, &00000955
          DCD     &00000330, &95580000, &55558002, &55562a55, &00000955
          DCD     &00000340, &25600000, &55558000, &55580255, &00000955
          DCD     &00000350, &0a800000, &55558000, &55a00095, &00000255
          DCD     &00000360, &00000000, &55560000, &56000095, &00000095
          DCD     &00000370, &00000000, &55560000, &58000095, &00000029
          DCD     &00000380, &00000000, &55560000, &a0000025, &00000002
          DCD     &00000390, &00000000, &55560000, &00000025, &00000000
          DCD     &000003a0, &00000000, &55560000, &00000025, &00000000
          DCD     &000003b0, &00000000, &55560000, &00000025, &00000000
          DCD     &000003c0, &00000000, &55580000, &00000009, &00000000
          DCD     &000003d0, &00000000, &aaa00000, &00000002, &00000000
          DCD     -1
          ; frame 2
          DCD     &00000010, &00000000, &00000000, &000002a8, &00000000
          DCD     &00000020, &00000000, &00000000, &0002a956, &00000000
          DCD     &00000030, &00000000, &80000000, &00095555, &00000000
          DCD     &00000040, &00000000, &80000000, &00095555, &00000000
          DCD     &00000050, &00000000, &8000002a, &00095555, &00000000
          DCD     &00000060, &a0000000, &60000095, &00095555, &00000000
          DCD     &00000070, &58000000, &60000255, &00095555, &00000000
          DCD     &00000080, &56000000, &58000955, &00095555, &00000000
          DCD     &00000090, &55800000, &5800a555, &00095555, &00000000
          DCD     &000000a0, &55800000, &58025555, &00095555, &00000000
          DCD     &000000b0, &55800000, &56a95555, &00095555, &00000a80
          DCD     &000000c0, &56000000, &55555555, &00095555, &00002568
          DCD     &000000d0, &56000000, &55555555, &80095555, &00009556
          DCD     &000000e0, &58000000, &55555555, &68a55555, &00025555
          DCD     &000000f0, &58000000, &55555555, &56555555, &00095555
          DCD     &00000100, &60000000, &55555555, &55555555, &00095555
          DCD     &00000110, &60000000, &55555555, &55555555, &00255555
          DCD     &00000120, &80000000, &55555555, &55555555, &00255555
          DCD     &00000130, &80000000, &55555555, &55555559, &00095555
          DCD     &00000140, &60000000, &a9555555, &555555a2, &00025555
          DCD     &00000150, &5a280000, &02a95555, &55555600, &00009555
          DCD     &00000160, &5596aa80, &00025555, &55556800, &00002555
          DCD     &00000170, &55555560, &00009555, &55558000, &00000955
          DCD     &00000180, &55555560, &00009555, &555a0000, &00000255
          DCD     &000001a0, &55555560, &00000955, &55580000, &00000095
          DCD     &000001b0, &55555558, &00000955, &55600000, &00000095
          DCD     &000001c0, &55555558, &00000255, &55600000, &00000255
          DCD     &000001d0, &55555558, &00000255, &55600000, &00002955
          DCD     &000001e0, &55555558, &00000255, &55600000, &000a9555
          DCD     &000001f0, &555556a0, &00000255, &55800000, &02a55555
          DCD     &00000200, &5555a800, &00000255, &55800000, &09555555
          DCD     &00000210, &555a0000, &00000255, &55800000, &09555555
          DCD     &00000220, &55a00000, &00000955, &55800000, &09555555
          DCD     &00000230, &55800000, &00000955, &55600000, &09555555
          DCD     &00000250, &55800000, &00000955, &55580000, &09555555
          DCD     &00000260, &55800000, &00002555, &55560000, &09555555
          DCD     &00000270, &55600000, &00009555, &55558000, &02555555
          DCD     &00000280, &55580000, &000a5555, &55558000, &02555555
          DCD     &00000290, &55560000, &00255555, &55556a00, &00aaaaa9
          DCD     &000002a0, &55558000, &82955555, &555555aa, &00000009
          DCD     &000002b0, &55556000, &69555555, &55555555, &00000002
          DCD     &000002c0, &55555800, &55555555, &55555555, &00000002
          DCD     &000002d0, &55555800, &55555555, &55555555, &00000002
          DCD     &000002e0, &55555800, &55555555, &55555555, &00000009
          DCD     &000002f0, &55556000, &55555555, &55555555, &00000009
          DCD     &00000300, &55556000, &555556a9, &55555555, &00000025
          DCD     &00000310, &95558000, &55555802, &55555555, &00000025
          DCD     &00000320, &29560000, &55556000, &55555555, &00000095
          DCD     &00000330, &02a80000, &55556000, &55556a95, &00000095
          DCD     &00000340, &00000000, &55556000, &55558025, &00000095
          DCD     &00000350, &00000000, &55556000, &55560025, &00000255
          DCD     &00000360, &00000000, &55556000, &55580009, &00000095
          DCD     &00000370, &00000000, &55556000, &55600009, &00000029
          DCD     &00000380, &00000000, &55556000, &55800002, &00000002
          DCD     &00000390, &00000000, &55556000, &a6000002, &00000000
          DCD     &000003a0, &00000000, &55556000, &08000002, &00000000
          DCD     &000003b0, &00000000, &95556000, &00000000, &00000000
          DCD     &000003c0, &00000000, &95568000, &00000000, &00000000
          DCD     &000003d0, &00000000, &2aa80000, &00000000, &00000000
          DCD     -1
          ; frame 3
          DCD     &00000010, &00000000, &00000000, &00000a80, &00000000
          DCD     &00000020, &00000000, &00000000, &0002a560, &00000000
          DCD     &00000030, &00000000, &00000200, &00295560, &00000000
          DCD     &00000040, &00000000, &000009a0, &00955558, &00000000
          DCD     &00000050, &00000000, &0000255a, &00955558, &00000000
          DCD     &00000060, &a0000000, &00009555, &00955556, &00000000
          DCD     &00000070, &58000000, &00009555, &00955556, &00000000
          DCD     &00000080, &58000000, &80025555, &00955555, &00000000
          DCD     &00000090, &58000000, &80095555, &00955555, &00000000
          DCD     &000000a0, &60000000, &60255555, &00955555, &00000000
          DCD     &000000b0, &60000000, &5a955555, &00955555, &00000000
          DCD     &000000c0, &60000000, &55555555, &00955555, &00000000
          DCD     &000000d0, &80000000, &55555555, &00255555, &0000aa00
          DCD     &000000e0, &80000000, &55555555, &00955555, &000255a8
          DCD     &000000f0, &80000000, &55555555, &a2555555, &00095556
          DCD     &00000100, &00000000, &55555556, &59555555, &00095555
          DCD     &00000110, &00000000, &55555556, &55555555, &00255555
          DCD     &00000130, &8002aa00, &55555555, &55555555, &00955555
          DCD     &00000140, &6aa95580, &aa555555, &555555aa, &00955555
          DCD     &00000150, &55555580, &00a95555, &55555600, &00255555
          DCD     &00000160, &55555580, &00025555, &55556800, &00095555
          DCD     &00000170, &55555560, &00009555, &55558000, &00025555
          DCD     &00000180, &55555560, &00009555, &55560000, &0000a555
          DCD     &00000190, &55555560, &00002555, &55580000, &00000955
          DCD     &000001a0, &55555558, &00000955, &55600000, &00000255
          DCD     &000001b0, &55555558, &00000255, &55600000, &00000255
          DCD     &000001c0, &555555a0, &00000255, &55600000, &00000255
          DCD     &000001d0, &55555a00, &00000255, &55600000, &00000255
          DCD     &000001e0, &5555a000, &00000255, &55600000, &00000255
          DCD     &000001f0, &555a0000, &00000255, &55600000, &00002955
          DCD     &00000200, &55600000, &00000255, &55800000, &00029555
          DCD     &00000210, &55800000, &00000255, &55800000, &00295555
          DCD     &00000220, &55800000, &00000955, &55800000, &02955555
          DCD     &00000250, &55680000, &00000955, &55580000, &09555555
          DCD     &00000260, &55560000, &00002555, &55560000, &09555555
          DCD     &00000270, &55558000, &00009555, &55558000, &02555555
          DCD     &00000280, &55556000, &000a5555, &55556000, &02555555
          DCD     &00000290, &55555800, &00255555, &55556800, &02555555
          DCD     &000002a0, &55555600, &aa955555, &555556aa, &009556a9
          DCD     &000002b0, &55555600, &55555555, &55555555, &002aa802
          DCD     &000002c0, &55555600, &55555555, &95555555, &00000000
          DCD     &000002d0, &55555600, &55555555, &95555555, &00000000
          DCD     &000002e0, &55555800, &55555555, &95555555, &00000000
          DCD     &000002f0, &95556000, &5555556a, &95555555, &00000000
          DCD     &00000300, &2a556000, &55555680, &55555555, &00000002
          DCD     &00000310, &00a98000, &55555600, &55555555, &00000002
          DCD     &00000320, &00020000, &55555600, &55555555, &00000002
          DCD     &00000330, &00000000, &55555600, &55555595, &00000009
          DCD     &00000340, &00000000, &55555600, &5555562a, &00000009
          DCD     &00000350, &00000000, &55555600, &55555802, &00000009
          DCD     &00000360, &00000000, &95555600, &55556000, &00000025
          DCD     &00000370, &00000000, &95555600, &55558000, &00000009
          DCD     &00000380, &00000000, &25555600, &55560000, &00000002
          DCD     &00000390, &00000000, &25555580, &a5580000, &00000000
          DCD     &000003a0, &00000000, &09555580, &0a600000, &00000000
          DCD     &000003b0, &00000000, &09555a00, &00800000, &00000000
          DCD     &000003c0, &00000000, &0256a000, &00000000, &00000000
          DCD     &000003d0, &00000000, &00a80000, &00000000, &00000000
          DCD     -1
          ; frame 4
          DCD     &00000010, &00000000, &00000000, &00000000, &00000000
          DCD     &00000020, &00000000, &00002000, &0002a000, &00000000
          DCD     &00000030, &00000000, &00009a00, &00a95800, &00000000
          DCD     &00000040, &00000000, &000255a0, &02555600, &00000000
          DCD     &00000050, &00000000, &0009555a, &09555580, &00000000
          DCD     &00000060, &80000000, &00095555, &09555580, &00000000
          DCD     &00000070, &80000000, &00255555, &09555560, &00000000
          DCD     &00000080, &80000000, &00955555, &09555560, &00000000
          DCD     &00000090, &00000000, &00955556, &09555558, &00000000
          DCD     &000000a0, &00000000, &a2555556, &09555556, &00000000
          DCD     &000000b0, &00000000, &59555556, &09555555, &00000000
          DCD     &000000c0, &00000000, &55555556, &02555555, &00000000
          DCD     &000000d0, &00000000, &55555558, &02555555, &00000000
          DCD     &000000e0, &00000000, &55555558, &02555555, &00000000
          DCD     &000000f0, &00000000, &55555558, &02555555, &0002a800
          DCD     &00000100, &00000000, &55555558, &09555555, &000956a8
          DCD     &00000110, &000aa800, &55555556, &a5555555, &00255556
          DCD     &00000120, &aaa55600, &55555556, &55555555, &00255555
          DCD     &00000130, &55555600, &55555555, &55555555, &00955555
          DCD     &00000140, &55555580, &aaa55555, &555556aa, &00955555
          DCD     &00000150, &55555580, &00095555, &55555800, &02555555
          DCD     &00000160, &55555580, &00095555, &55556000, &02555555
          DCD     &00000170, &55555560, &00025555, &55558000, &00955555
          DCD     &00000180, &55555560, &00009555, &55560000, &00255555
          DCD     &00000190, &55555560, &00002555, &55580000, &000a5555
          DCD     &000001a0, &55555680, &00000955, &55600000, &00009555
          DCD     &000001b0, &55556800, &00000255, &55600000, &00002555
          DCD     &000001c0, &55558000, &00000255, &55600000, &00000a55
          DCD     &000001d0, &555a0000, &00000255, &55600000, &00000255
          DCD     &000001e0, &55600000, &00000255, &55600000, &00000255
          DCD     &000001f0, &55800000, &00000255, &55600000, &00000255
          DCD     &00000200, &55800000, &00000255, &55600000, &00000255
          DCD     &00000210, &55800000, &00000255, &55600000, &00002955
          DCD     &00000220, &55a00000, &00000255, &55600000, &00029555
          DCD     &00000230, &55580000, &00000255, &55600000, &00095555
          DCD     &00000240, &55560000, &00000955, &55600000, &00a55555
          DCD     &00000250, &5555a000, &00000955, &55580000, &02555555
          DCD     &00000260, &55555800, &00002555, &55560000, &09555555
          DCD     &00000270, &55555600, &00029555, &55558000, &02555555
          DCD     &00000280, &55555580, &00095555, &55556000, &02555555
          DCD     &00000290, &55555580, &00255555, &55555800, &02555555
          DCD     &000002a0, &55555580, &aa955555, &555556aa, &00955555
          DCD     &000002b0, &55555600, &55555555, &55555555, &00955555
          DCD     &000002c0, &55555600, &55555555, &95555555, &002556aa
          DCD     &000002d0, &95555800, &55555556, &25555555, &000aa800
          DCD     &000002e0, &2a955800, &55555558, &09555555, &00000000
          DCD     &000002f0, &002aa000, &55555560, &25555555, &00000000
          DCD     &00000300, &00000000, &55555580, &25555555, &00000000
          DCD     &00000310, &00000000, &55555560, &25555555, &00000000
          DCD     &00000320, &00000000, &55555560, &25555555, &00000000
          DCD     &00000330, &00000000, &55555560, &95555555, &00000000
          DCD     &00000340, &00000000, &a5555560, &9555556a, &00000000
          DCD     &00000350, &00000000, &25555560, &95555580, &00000000
          DCD     &00000360, &00000000, &09555560, &95555600, &00000000
          DCD     &00000370, &00000000, &02555558, &55555600, &00000002
          DCD     &00000380, &00000000, &02555558, &55555800, &00000002
          DCD     &00000390, &00000000, &00955558, &a5556000, &00000000
          DCD     &000003a0, &00000000, &00955560, &0a558000, &00000000
          DCD     &000003b0, &00000000, &00255680, &00a58000, &00000000
          DCD     &000003c0, &00000000, &000aa800, &000a0000, &00000000
          DCD     &000003d0, &00000000, &00000000, &00000000, &00000000
          DCD     -1
          ; frame 5
          DCD     &00000020, &00000000, &000aa000, &00080000, &00000000
          DCD     &00000030, &00000000, &00255a00, &00a60000, &00000000
          DCD     &00000040, &00000000, &009555a0, &0a558000, &00000000
          DCD     &00000050, &00000000, &00955558, &a5556000, &00000000
          DCD     &00000060, &00000000, &02555558, &55555800, &00000002
          DCD     &00000070, &00000000, &02555558, &55555800, &00000002
          DCD     &00000080, &00000000, &09555560, &95555600, &00000000
          DCD     &00000090, &00000000, &25555560, &95555580, &00000000
          DCD     &000000a0, &00000000, &a5555560, &95555562, &00000000
          DCD     &000000b0, &00000000, &55555560, &95555559, &00000000
          DCD     &000000c0, &00000000, &55555560, &25555555, &00000000
          DCD     &000000d0, &00000000, &55555560, &25555555, &00000000
          DCD     &000000e0, &00000000, &55555580, &25555555, &00000000
          DCD     &000000f0, &002aa000, &555555a0, &25555555, &00000000
          DCD     &00000100, &0a955800, &55555558, &25555555, &00000000
          DCD     &00000110, &a5555800, &55555556, &25555555, &000aa800
          DCD     &00000120, &55555600, &55555555, &95555555, &002556aa
          DCD     &00000140, &55555580, &aa955555, &555556aa, &00955555
          DCD     &00000150, &55555580, &00255555, &55555800, &02555555
          DCD     &00000170, &55555600, &00025555, &55558000, &02555555
          DCD     &00000180, &55555800, &00009555, &55560000, &09555555
          DCD     &00000190, &55556000, &00002955, &55580000, &02555555
          DCD     &000001a0, &55568000, &00000955, &55600000, &00955555
          DCD     &000001b0, &55580000, &00000955, &55600000, &00295555
          DCD     &000001c0, &55600000, &00000955, &55600000, &00029555
          DCD     &000001d0, &55800000, &00000255, &55600000, &00002555
          DCD     &000001e0, &55800000, &00000255, &55600000, &00000a55
          DCD     &00000200, &55a00000, &00000255, &55600000, &00000255
          DCD     &00000210, &55580000, &00000255, &55600000, &00000255
          DCD     &00000220, &55568000, &00000255, &55600000, &00000255
          DCD     &00000230, &55556800, &00000255, &55600000, &00002955
          DCD     &00000240, &55555680, &00000955, &55600000, &00009555
          DCD     &00000250, &55555560, &00002555, &55580000, &000a5555
          DCD     &00000260, &55555560, &00009555, &55560000, &00255555
          DCD     &00000270, &55555560, &00025555, &55558000, &00955555
          DCD     &00000280, &55555580, &00025555, &55556000, &02555555
          DCD     &00000290, &55555580, &00095555, &55555800, &02555555
          DCD     &000002a0, &55555580, &aaa55555, &555556aa, &00955555
          DCD     &000002c0, &aa955600, &55555555, &55555555, &00955555
          DCD     &000002d0, &002aa800, &55555556, &a5555555, &00255556
          DCD     &000002e0, &00000000, &55555558, &09555555, &000956a8
          DCD     &000002f0, &00000000, &55555558, &02555555, &0002a800
          DCD     &00000300, &00000000, &55555558, &02555555, &00000000
          DCD     &00000310, &00000000, &55555558, &02555555, &00000000
          DCD     &00000320, &00000000, &55555556, &02555555, &00000000
          DCD     &00000330, &00000000, &55555556, &09555555, &00000000
          DCD     &00000340, &00000000, &aa555556, &09555556, &00000000
          DCD     &00000350, &00000000, &02555556, &09555558, &00000000
          DCD     &00000360, &80000000, &00955555, &09555560, &00000000
          DCD     &00000370, &80000000, &00255555, &09555560, &00000000
          DCD     &00000380, &80000000, &00095555, &09555580, &00000000
          DCD     &00000390, &00000000, &00095556, &09555580, &00000000
          DCD     &000003a0, &00000000, &00025568, &02555600, &00000000
          DCD     &000003b0, &00000000, &00009a80, &00a55600, &00000000
          DCD     &000003c0, &00000000, &00002000, &000aa800, &00000000
          DCD     -1
          ; frame 6
          DCD     &00000010, &00000000, &00a00000, &00000000, &00000000
          DCD     &00000020, &00000000, &025aa000, &00000000, &00000000
          DCD     &00000030, &00000000, &09555800, &00800000, &00000000
          DCD     &00000040, &00000000, &09555600, &0a600000, &00000000
          DCD     &00000050, &00000000, &25555600, &a5580000, &00000000
          DCD     &00000060, &00000000, &25555600, &55560000, &00000002
          DCD     &00000070, &00000000, &95555600, &55558000, &00000009
          DCD     &00000080, &00000000, &95555600, &55556000, &00000025
          DCD     &00000090, &00000000, &55555600, &55555802, &00000025
          DCD     &000000a0, &00000000, &55555600, &5555580a, &00000009
          DCD     &000000b0, &00000000, &55555600, &555556a5, &00000009
          DCD     &000000c0, &00000000, &55555600, &55555555, &00000009
          DCD     &000000d0, &00aa0000, &55555600, &55555555, &00000002
          DCD     &000000e0, &2a558000, &55555600, &55555555, &00000002
          DCD     &000000f0, &95556000, &555555a2, &95555555, &00000000
          DCD     &00000100, &55555800, &55555559, &95555555, &00000000
          DCD     &00000110, &55555800, &55555555, &95555555, &00000000
          DCD     &00000120, &55555600, &55555555, &95555555, &00000000
          DCD     &00000130, &55555600, &55555555, &55555555, &002aa002
          DCD     &00000140, &55555600, &aa955555, &555555aa, &00955aa9
          DCD     &00000150, &55555800, &00255555, &55556a00, &02555555
          DCD     &00000160, &55556000, &00095555, &55556000, &02555555
          DCD     &00000170, &55558000, &00029555, &55558000, &02555555
          DCD     &00000180, &55560000, &00002555, &55560000, &09555555
          DCD     &00000190, &55580000, &00000955, &55580000, &09555555
          DCD     &000001a0, &55a00000, &00000955, &55580000, &09555555
          DCD     &000001b0, &55800000, &00000955, &55600000, &09555555
          DCD     &000001c0, &55800000, &00000955, &55800000, &02555555
          DCD     &000001d0, &55800000, &00000955, &55800000, &00a55555
          DCD     &000001e0, &55a00000, &00000255, &55800000, &000a5555
          DCD     &000001f0, &555a0000, &00000255, &55600000, &0000a555
          DCD     &00000200, &5555a000, &00000255, &55600000, &00000a55
          DCD     &00000210, &55555a00, &00000255, &55600000, &00000255
          DCD     &00000220, &55555580, &00000255, &55600000, &00000255
          DCD     &00000230, &55555560, &00000255, &55600000, &00000255
          DCD     &00000240, &55555560, &00000955, &55600000, &00000255
          DCD     &00000250, &55555560, &00002555, &55600000, &00000955
          DCD     &00000260, &55555560, &00009555, &555a0000, &00002555
          DCD     &00000270, &55555560, &00009555, &55558000, &00029555
          DCD     &00000280, &55555580, &00025555, &55556000, &00095555
          DCD     &00000290, &55555580, &00295555, &55555a00, &00255555
          DCD     &000002a0, &6a955580, &aa955555, &555555aa, &00955555
          DCD     &000002b0, &802aaa00, &55555555, &55555555, &00955555
          DCD     &000002c0, &80000000, &55555555, &55555555, &00955555
          DCD     &000002d0, &00000000, &55555556, &55555555, &00255555
          DCD     &000002e0, &00000000, &55555556, &59555555, &00255555
          DCD     &000002f0, &80000000, &55555555, &a2555555, &00095556
          DCD     &00000300, &80000000, &55555555, &00955555, &000255a8
          DCD     &00000310, &80000000, &55555555, &00955555, &0000aa00
          DCD     &00000320, &60000000, &55555555, &00955555, &00000000
          DCD     &00000330, &60000000, &56955555, &00955555, &00000000
          DCD     &00000340, &60000000, &a8255555, &00955555, &00000000
          DCD     &00000350, &58000000, &80095555, &00955555, &00000000
          DCD     &00000360, &58000000, &00025555, &00955556, &00000000
          DCD     &00000370, &58000000, &00025555, &00955556, &00000000
          DCD     &00000380, &a0000000, &00009555, &00955556, &00000000
          DCD     &00000390, &00000000, &00002556, &00955558, &00000000
          DCD     &000003a0, &00000000, &00000968, &00955558, &00000000
          DCD     &000003b0, &00000000, &00000280, &00255560, &00000000
          DCD     &000003c0, &00000000, &00000000, &000aa560, &00000000
          DCD     &000003d0, &00000000, &00000000, &00000a80, &00000000
          DCD     -1
          ; frame 7
          DCD     &00000010, &00000000, &2aa00000, &00000000, &00000000
          DCD     &00000020, &00000000, &955a8000, &00000000, &00000000
          DCD     &00000030, &00000000, &95556000, &00000000, &00000000
          DCD     &00000040, &00000000, &55556000, &08000002, &00000000
          DCD     &00000050, &00000000, &55556000, &a6000002, &00000000
          DCD     &00000060, &00000000, &55556000, &55800002, &00000002
          DCD     &00000070, &00000000, &55556000, &55600009, &00000029
          DCD     &00000080, &00000000, &55556000, &55580009, &00000095
          DCD     &00000090, &00000000, &55556000, &55560025, &00000255
          DCD     &000000a0, &00000000, &55556000, &55558025, &00000255
          DCD     &000000b0, &00a80000, &55556000, &55556a95, &00000095
          DCD     &000000c0, &2a560000, &55556000, &55555555, &00000095
          DCD     &000000d0, &95558000, &55556802, &55555555, &00000025
          DCD     &000000e0, &55558000, &555556a9, &55555555, &00000025
          DCD     &000000f0, &55556000, &55555555, &55555555, &00000009
          DCD     &00000100, &55555800, &55555555, &55555555, &00000009
          DCD     &00000110, &55555800, &55555555, &55555555, &00000009
          DCD     &00000120, &55555800, &55555555, &55555555, &00000002
          DCD     &00000130, &55556000, &65555555, &55555555, &00000002
          DCD     &00000140, &55558000, &8a555555, &5555556a, &00000009
          DCD     &00000150, &55560000, &00a55555, &55556a80, &002aaaa9
          DCD     &00000160, &55580000, &00095555, &55558000, &00955555
          DCD     &00000170, &55600000, &00029555, &55558000, &02555555
          DCD     &00000180, &55800000, &00002555, &55560000, &09555555
          DCD     &00000190, &56000000, &00000955, &55580000, &09555555
          DCD     &000001a0, &55800000, &00000955, &55580000, &09555555
          DCD     &000001c0, &55800000, &00000955, &55800000, &09555555
          DCD     &000001d0, &556a0000, &00000955, &55800000, &25555555
          DCD     &000001e0, &5555a000, &00000255, &55800000, &09555555
          DCD     &000001f0, &55555a80, &00000255, &55800000, &02a55555
          DCD     &00000200, &55555560, &00000255, &55600000, &000a5555
          DCD     &00000210, &55555558, &00000255, &55600000, &0000a955
          DCD     &00000220, &55555558, &00000255, &55600000, &00000255
          DCD     &00000230, &55555558, &00000955, &55600000, &00000255
          DCD     &00000240, &55555560, &00000955, &55600000, &00000095
          DCD     &00000250, &55555560, &00002555, &55580000, &00000095
          DCD     &00000260, &55555560, &00009555, &55580000, &00000255
          DCD     &00000270, &55555560, &00009555, &55568000, &00000955
          DCD     &00000280, &55555580, &00025555, &55556000, &00002555
          DCD     &00000290, &5aaaaa00, &00a95555, &55555a00, &00009555
          DCD     &000002a0, &60000000, &aa555555, &555555a2, &00025555
          DCD     &000002b0, &80000000, &55555555, &55555559, &00095555
          DCD     &000002c0, &80000000, &55555555, &55555555, &00255555
          DCD     &000002d0, &60000000, &55555555, &55555555, &00255555
          DCD     &000002e0, &60000000, &55555555, &55555555, &00255555
          DCD     &000002f0, &58000000, &55555555, &55555555, &00095555
          DCD     &00000300, &58000000, &55555555, &6a955555, &00025555
          DCD     &00000310, &56000000, &55555555, &80295555, &00025556
          DCD     &00000320, &56000000, &55555555, &00095555, &00009568
          DCD     &00000330, &56000000, &56a95555, &00095555, &00002a80
          DCD     &00000340, &55800000, &58025555, &00095555, &00000000
          DCD     &00000350, &55800000, &58009555, &00095555, &00000000
          DCD     &00000360, &56000000, &60002555, &00095555, &00000000
          DCD     &00000370, &58000000, &60000955, &00095555, &00000000
          DCD     &00000380, &a0000000, &60000255, &00095555, &00000000
          DCD     &00000390, &00000000, &8000009a, &00095555, &00000000
          DCD     &000003a0, &00000000, &80000020, &00095555, &00000000
          DCD     &000003b0, &00000000, &80000000, &00095555, &00000000
          DCD     &000003c0, &00000000, &00000000, &0002a556, &00000000
          DCD     &000003d0, &00000000, &00000000, &00000aa8, &00000000
          DCD     -1
          ; frame 8
          DCD     &00000010, &00000000, &aaa00000, &00000002, &00000000
          DCD     &00000020, &00000000, &55580000, &00000009, &00000000
          DCD     &00000030, &00000000, &55560000, &00000025, &00000000
          DCD     &00000040, &00000000, &55560000, &00000025, &00000000
          DCD     &00000050, &00000000, &55560000, &00000025, &00000000
          DCD     &00000060, &00000000, &55560000, &80000095, &00000002
          DCD     &00000070, &00000000, &55560000, &68000095, &00000029
          DCD     &00000080, &00000000, &55560000, &56000095, &00000095
          DCD     &00000090, &0a800000, &55560000, &55800095, &00000255
          DCD     &000000a0, &25600000, &55560000, &55600255, &00000955
          DCD     &000000b0, &95580000, &55560002, &555a0a55, &00002555
          DCD     &000000c0, &55560000, &55558029, &5555a555, &00000955
          DCD     &000000d0, &55558000, &55556a95, &55555555, &00000955
          DCD     &000000e0, &55558000, &55555555, &55555555, &00000255
          DCD     &000000f0, &55556000, &55555555, &55555555, &00000255
          DCD     &00000100, &55558000, &55555555, &55555555, &00000095
          DCD     &00000110, &55558000, &55555555, &55555555, &00000095
          DCD     &00000120, &55560000, &55555555, &55555555, &00000025
          DCD     &00000130, &55580000, &a5555555, &55555555, &00000009
          DCD     &00000140, &55600000, &0a555555, &5555556a, &00000009
          DCD     &00000150, &55800000, &00a55555, &55555a80, &00000009
          DCD     &00000160, &56000000, &000a5555, &5555a000, &00000025
          DCD     &00000170, &56000000, &00009555, &55560000, &0000aaa5
          DCD     &00000180, &56000000, &00002555, &55560000, &02aa5555
          DCD     &00000190, &56000000, &00002555, &55580000, &09555555
          DCD     &000001a0, &56000000, &00002555, &55580000, &09555555
          DCD     &000001b0, &55aa0000, &00000955, &55600000, &09555555
          DCD     &000001c0, &5555a800, &00000955, &55600000, &09555555
          DCD     &000001d0, &555556a0, &00000955, &55800000, &25555555
          DCD     &000001e0, &55555558, &00000255, &55800000, &25555555
          DCD     &000001f0, &55555558, &00000255, &55800000, &25555555
          DCD     &00000200, &55555558, &00000255, &55800000, &25555555
          DCD     &00000210, &55555558, &00000255, &55600000, &0a555555
          DCD     &00000220, &55555558, &00000955, &55600000, &00aa5555
          DCD     &00000230, &55555560, &00000955, &55600000, &0000aa55
          DCD     &00000240, &55555560, &00002555, &55580000, &00000095
          DCD     &00000260, &5555aa80, &00009555, &55580000, &00000095
          DCD     &00000270, &56aa0000, &00009555, &55560000, &00000095
          DCD     &00000280, &58000000, &00025555, &5555a000, &00000095
          DCD     &00000290, &58000000, &02a95555, &55555a00, &00000255
          DCD     &000002a0, &60000000, &a9555555, &555555a0, &00000955
          DCD     &000002b0, &58000000, &55555555, &5555555a, &00002555
          DCD     &000002c0, &58000000, &55555555, &55555555, &00009555
          DCD     &000002d0, &56000000, &55555555, &55555555, &00009555
          DCD     &000002e0, &56000000, &55555555, &55555555, &00025555
          DCD     &000002f0, &55800000, &55555555, &55555555, &00095555
          DCD     &00000300, &55800000, &55555555, &55555555, &00025555
          DCD     &00000310, &55600000, &55555555, &56a95555, &00025555
          DCD     &00000320, &55600000, &55569555, &68025555, &00009555
          DCD     &00000330, &55580000, &55a82555, &80009555, &00002555
          DCD     &00000340, &55600000, &55800955, &00009555, &0000095a
          DCD     &00000350, &55800000, &55800255, &00009555, &000002a0
          DCD     &00000360, &56000000, &56000095, &00009555, &00000000
          DCD     &00000370, &58000000, &56000029, &00009555, &00000000
          DCD     &00000380, &a0000000, &56000002, &00009555, &00000000
          DCD     &00000390, &00000000, &58000000, &00009555, &00000000
          DCD     &000003a0, &00000000, &58000000, &00009555, &00000000
          DCD     &000003b0, &00000000, &58000000, &00009555, &00000000
          DCD     &000003c0, &00000000, &58000000, &00002555, &00000000
          DCD     &000003d0, &00000000, &a0000000, &00000aaa, &00000000
          DCD     -1

; Offsets into the deltas for each frame
frame_deltas
          DCD     0  ; frame 0
          DCD     1284  ; frame 1
          DCD     2488  ; frame 2
          DCD     3672  ; frame 3
          DCD     4836  ; frame 4
          DCD     6060  ; frame 5
          DCD     7164  ; frame 6
          DCD     8388  ; frame 7
          DCD     9592  ; frame 8

; Palette data
palette
          DCB     0, 153, 14
          DCB     0, 0, 0
          ALIGN

; Read the period between frames
; <=  R0 = cs between frames
hourglass_getframeperiod SIGNATURE
          EXPORT  hourglass_getframeperiod
          MOV     r0, #period
          MOV     pc, lr


; Read the size of the workspace block
; <=  R0 = size of hourglass workspace
hourglass_getwssize SIGNATURE
          EXPORT  hourglass_getwssize
    [ hg_workspacesize < &400
          MOV     r0, #hg_workspacesize
    |
          MOV     r0, #hg_workspacesize :AND: 1023
          ORR     r0, r0, #hg_workspacesize :AND: (1023<<10)
    ]
          MOV     pc, lr

; Initialisation function
; =>  R0 = hourglass workspace
hourglass_init SIGNATURE
          EXPORT  hourglass_init
          MOV     r12, r0
          MOV     r0, #0
          STR     r0, hg_framenum
          STR     r0, hg_percentage
          STR     r0, hg_leds
          LDR     r0, wordblock_0
          STR     r0, hg_word
          LDR     r0, wordblock_4
          ADR     r1, hg_currentdata
          ORR     r0, r0, r1, LSL #16         ; assign the low half word of pointer data
          STR     r0, hg_word + 4
          MOV     r0, r1, LSR #16             ; and the high half word
          STR     r0, hg_word + 8
; no need to initialise the currentdata; it will be updated by the first frame
          MOV     pc, lr

wordblock_0
          DCB     0                           ; define pointer shape
          DCB     3                           ; shape number (will toggle 3-4)
          DCB     (width*2+7)/8               ; width in bytes
          DCB     height                      ; height
wordblock_4
          DCB     active_x                    ; active x offset
          DCB     active_y                    ; active y offset
          DCB     0                           ; b0-7 of the address of the pointer data
          DCB     0                           ; b8-15 of address of the pointer data

; Start the hourglass
; =>  R0 = hourglass workspace
hourglass_start SIGNATURE
          EXPORT  hourglass_start
          STMFD   sp!, {r4, r5, lr}
          SUB     sp, sp, #8
          MOV     r12, r0
          MOV     r0, #0
          STR     r0, hg_framenum
          MOV     r0, #1
          MOV     r1, #25                     ; read pointer colour 1
          SWI     XOS_ReadPalette
          LDRVS   r2, =&81397900              ; purple if it wasn't set
          STR     r2, hg_oldcolours + 4 * 0
          MOV     r0, #2
          MOV     r1, #25                     ; read pointer colour 2
          SWI     XOS_ReadPalette
          LDRVS   r2, =&66FFFF00              ; yellow if it wasn't set
          STR     r2, hg_oldcolours + 4 * 1
          MOV     r0, #3
          MOV     r1, #25                     ; read pointer colour 3
          SWI     XOS_ReadPalette
          LDRVS   r2, =&00000000              ; black if it wasn't set
          STR     r2, hg_oldcolours + 4 * 2
; now set the palette up for our hourglass
          MOV     r1, sp
          ADRL    r2, palette
; colour 1
          MOV     r0, #1
          STRB    r0, [r1, #0]
          MOV     r0, #25                     ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                ; blue
          MOV     r0, #12
          SWI     XOS_Word                    ; Set palette
; colour 2
          MOV     r0, #2
          STRB    r0, [r1, #0]
          MOV     r0, #25                     ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                ; blue
          MOV     r0, #12
          SWI     XOS_Word                    ; Set palette
          MOV     r1, #127                        ; invalid pointer number to read the pointer
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte
          MOVVS   r1, #0                          ; if there was an error, turn off
          STR     r1, hg_oldpointer
          ADD     sp, sp, #8
          LDMFD   sp!, {r4, r5, lr}
          MOV     r0, r12
          B       hourglass_frame                 ; exit via the first frame

; Stop the hourglass
; =>  R0 = hourglass workspace
hourglass_stop SIGNATURE
          EXPORT  hourglass_stop
          STMFD   sp!, {r4, r5, lr}
          SUB     sp, sp, #8
          MOV     r12, r0
          LDR     r4, hg_oldpointer               ; work out the old pointer shape
          BIC     r4, r4, #127                    ; turn off the pointer whilst we change colours
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte
; restore the palette up for old pointer
          MOV     r1, sp
; colour 1
          ADR     r2, hg_oldcolours + 4 * 0 + 1
          MOV     r0, #1
          STRB    r0, [r1, #0]
          MOV     r0, #25                         ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                    ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                    ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                    ; blue
          MOV     r0, #12
          SWI     XOS_Word                        ; Set palette
; colour 2
          ADR     r2, hg_oldcolours + 4 * 1 + 1
          MOV     r0, #2
          STRB    r0, [r1, #0]
          MOV     r0, #25                         ; set pointer colour 1
          STRB    r0, [r1, #1]
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #2]                    ; red
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #3]                    ; green
          LDRB    r0, [r2], #1
          STRB    r0, [r1, #4]                    ; blue
          MOV     r0, #12
          SWI     XOS_Word                        ; Set palette
          MOV     r1, r4                          ; re-select the old pointer number
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte
          ADD     sp, sp, #8
          LDMFD   sp!, {r4, r5, pc}

; Frame update - sets the hourglass shape for the current frame
; =>  R0 = hourglass workspace
hourglass_frame SIGNATURE
          EXPORT  hourglass_frame
          STMFD   sp!, {r4, r5, lr}
          MOV     r12, r0
          LDR     r0, hg_framenum
          ADRL    r1, frame_deltas
          LDR     r0, [r1, r0, LSL #2]            ; offset within deltas for this frame
          ADRL    r1, deltas
          ADD     r1, r1, r0
          ADRL    r5, hg_currentdata
rowloop
          LDR     r3, [r1], #4                    ; r3 = currentdata offset
          CMP     r3, #-1                         ; end of the rows
          BEQ     rowend
      [ wordsperrow = 1
          LDR     r0, [r1], #4                    ; read a word
          STR     r0, [r3, r5]                    ; store into the currentdata
      ]
      [ wordsperrow = 2
          LDMIA   r1!, {r0, r2}                   ; read two word from rowdata
          STR     r0, [r3, r5]!                   ; store into the currentdata
          STR     r2, [r3, #4]                    ; store into the currentdata
      ]
      [ wordsperrow = 3
          LDMIA   r1!, {r0, r2, r4}               ; read a word from rowdata
          ADD     r3, r3, r5                      ; work out the line offset
          STMIA   r3!, {r0, r2, r4}               ; store into the currentdata
      ]
      [ wordsperrow = 4
          LDMIA   r1!, {r0, r2, r4, lr}           ; read a word from rowdata
          ADD     r3, r3, r5                      ; work out the line offset
          STMIA   r3!, {r0, r2, r4, lr}           ; store into the currentdata
      ]
          B       rowloop

rowend
          MOV     r0, #21                         ; Set Pointer parameters
          ADR     r1, hg_word
          SWI     XOS_Word

          LDRB    r1, hg_word + 1                 ; get the hourglass pointer number we will use
          RSB     lr, r1, #7                      ; toggles 3 to 4
          STRB    lr, hg_word + 1                 ; toggles the pointer number we use next time
          MOV     r0, #106                        ; select pointer
          SWI     XOS_Byte

          LDR     r0, hg_framenum
          ADD     r0, r0, #1
          TEQ     r0, #nframes
          MOVEQ   r0, #0                          ; reset counter; we've cycled
          STR     r0, hg_framenum
          LDMFD   sp!, {r4, r5, pc}

; Frame update within an IRQ
; =>  R12 = hourglass workspace
hourglass_frame_irq SIGNATURE
          EXPORT  hourglass_frame_irq
          STMFD   sp!, {r0-r3, r4, r5, r12, lr}
          MOV     r0, r12
          MRS     r4, CPSR
          BIC     r1, r4, #&F
          ORR     r1, r1, #&3
          MSR     CPSR_csxf, r1                    ; Enter SVC mode (keep bitness)
          MOV     r5, lr
          BL      hourglass_frame
          MOV     lr, r5
          MSR     CPSR_cxsf, r4                    ; Restore the mode
          LDMFD   sp!, {r0-r3, r4, r5, r12, pc}

          END
