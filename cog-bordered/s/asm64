          AREA |C$$code|, CODE, READONLY

; constants
width             * 32
height            * 32
period            * 3
wordsperrow       * 2
nwords            * 480
nframes           * 9
active_x          * 16
active_y          * 16

; Workspace for changing the hourglass rendition
                  ^ 0, x12
hg_framenum       # 4                         ; frame number
hg_percentage     # 4                         ; percentage to show (N/I)
hg_leds           # 4                         ; LED flags (N/I)
hg_oldpointer     # 4                         ; Old pointer configuration
hg_oldcolours     # 4 * 3                     ; Old palette entries
hg_word           # 12                        ; OS_Word block
hg_currentdata    # 4 * wordsperrow * height  ; Current data for the hourglass
hg_workspacesize  * :INDEX: @                 ; Size of this workspace

; SWI numbers
XOS_Byte          * 0x20006
XOS_Word          * 0x20007
XOS_ReadPalette   * 0x2002F

; -------------------------------------------------
        MACRO
$label  SIGNATURE
        ALIGN   4
        =       "$label",0
        ALIGN   4
        DCD     &FF000000+(:LEN:"$label"+4):AND::NOT:3
$label
        MEND

        MACRO
$label  SWI     $name
$label
        MOV     x10, #$name :AND: &FFFF
        ADD     x10, x10, #$name :AND: &FFFF0000
        SVC     #0
        MEND


; Data for deltas between frames
deltas
          ; frame 0
          DCD     &00000000, &a0000000, &0000000a
          DCD     &00000008, &58000000, &00000025
          DCD     &00000010, &58000000, &00000025
          DCD     &00000018, &5600a000, &00020025
          DCD     &00000020, &56025800, &00098025
          DCD     &00000028, &56095600, &00256895
          DCD     &00000030, &55a55580, &00955655
          DCD     &00000038, &55555600, &00955555
          DCD     &00000040, &55555600, &00955555
          DCD     &00000048, &55555800, &00255555
          DCD     &00000050, &a5556000, &0009555a
          DCD     &00000058, &0a556000, &000955a0
          DCD     &00000060, &00955a80, &02a95600
          DCD     &00000068, &00955568, &29555600
          DCD     &00000070, &00255556, &95555800
          DCD     &00000078, &00255556, &95555800
          DCD     &00000080, &00255556, &95555800
          DCD     &00000088, &00255556, &25555600
          DCD     &00000090, &009556a8, &0a955600
          DCD     &00000098, &00955800, &00295600
          DCD     &000000a0, &0a556000, &000955a8
          DCD     &000000a8, &a5555800, &00095556
          DCD     &000000b0, &55555800, &00255555
          DCD     &000000b8, &55555600, &00955555
          DCD     &000000c0, &55555580, &00955555
          DCD     &000000c8, &56a55600, &00955a95
          DCD     &000000d0, &56095600, &00256095
          DCD     &000000d8, &5602a800, &000a8025
          DCD     &000000e0, &56000000, &00000025
          DCD     &000000e8, &58000000, &00000025
          DCD     &000000f0, &58000000, &00000009
          DCD     &000000f8, &a0000000, &00000002
          DCD     -1
          ; frame 1
          DCD     &00000000, &80000000, &0000002a
          DCD     &00000008, &60000000, &00000095
          DCD     &00000010, &60000000, &00000095
          DCD     &00000018, &5802a000, &00000095
          DCD     &00000020, &58295800, &00080095
          DCD     &00000028, &5a955600, &00268255
          DCD     &00000030, &55555600, &00956a55
          DCD     &00000038, &55555800, &02555555
          DCD     &00000040, &55555800, &02555555
          DCD     &00000048, &55556000, &00955555
          DCD     &00000050, &a5556000, &0025555a
          DCD     &00000058, &0a556aa0, &000955a0
          DCD     &00000060, &00955558, &00095600
          DCD     &00000068, &00955556, &00a55600
          DCD     &00000070, &00255556, &2a555600
          DCD     &00000088, &002555a8, &95555600
          DCD     &00000090, &00955a00, &25555600
          DCD     &00000098, &00955800, &0aa55580
          DCD     &000000a0, &0a555800, &000955a8
          DCD     &000000a8, &a5555600, &00095556
          DCD     &000000b0, &55555580, &00095555
          DCD     &000000b8, &55555580, &00255555
          DCD     &000000c0, &55655580, &00255555
          DCD     &000000c8, &558a5600, &00955595
          DCD     &000000d0, &5580a800, &00255625
          DCD     &000000d8, &55800000, &00096809
          DCD     &000000e0, &55800000, &00028009
          DCD     &000000e8, &56000000, &00000009
          DCD     &000000f0, &58000000, &00000002
          DCD     &000000f8, &a0000000, &00000000
          DCD     -1
          ; frame 2
          DCD     &00000000, &00000000, &000000aa
          DCD     &00000008, &80000000, &00000255
          DCD     &00000010, &800a0000, &00000255
          DCD     &00000018, &8025a000, &00000255
          DCD     &00000020, &60955800, &00000255
          DCD     &00000028, &6a555800, &00280255
          DCD     &00000030, &55556000, &00968955
          DCD     &00000038, &55556000, &02556955
          DCD     &00000040, &55556000, &09555555
          DCD     &00000048, &55558000, &09555555
          DCD     &00000050, &a9556aa0, &0255555a
          DCD     &00000058, &02555558, &009555a0
          DCD     &00000060, &00955556, &00255600
          DCD     &00000068, &00955556, &00255600
          DCD     &00000070, &00255556, &00a55600
          DCD     &00000078, &00255558, &0a555800
          DCD     &00000080, &002555a0, &25555800
          DCD     &00000088, &00255a00, &95555800
          DCD     &00000090, &00955800, &95555600
          DCD     &00000098, &02955800, &25555580
          DCD     &000000a0, &09555600, &0aa955a8
          DCD     &000000a8, &a5555580, &00025556
          DCD     &000000b0, &55555560, &00025555
          DCD     &000000b8, &55555560, &00095555
          DCD     &000000c0, &556a5580, &00095555
          DCD     &000000c8, &5560a600, &00095555
          DCD     &000000d0, &55600800, &002555a9
          DCD     &000000d8, &55600000, &00095602
          DCD     &000000e0, &55600000, &00025802
          DCD     &000000e8, &55600000, &0000a002
          DCD     &000000f0, &96800000, &00000000
          DCD     &000000f8, &28000000, &00000000
          DCD     -1
          ; frame 3
          DCD     &00000000, &00000000, &000000a0
          DCD     &00000008, &00280000, &00000a58
          DCD     &00000010, &00960000, &00002556
          DCD     &00000018, &00958000, &00002556
          DCD     &00000020, &82556000, &00000955
          DCD     &00000028, &69556000, &00000955
          DCD     &00000030, &55558000, &00a80955
          DCD     &00000038, &55558000, &0256a555
          DCD     &00000040, &55558000, &09555555
          DCD     &00000048, &5555aaa0, &09555555
          DCD     &00000050, &a9555558, &0955555a
          DCD     &00000058, &02555558, &025555a0
          DCD     &00000060, &00955556, &00955600
          DCD     &00000068, &00255556, &00255600
          DCD     &00000070, &00255558, &00255800
          DCD     &00000078, &002555a0, &00a55800
          DCD     &00000080, &00255a00, &0a555800
          DCD     &00000088, &00255800, &25555800
          DCD     &00000090, &00955a00, &95555600
          DCD     &00000098, &02955580, &25555580
          DCD     &000000a0, &09555560, &255555a8
          DCD     &000000a8, &a5555558, &0aaa5556
          DCD     &000000b8, &55565560, &00025555
          DCD     &000000c0, &5558a980, &00025555
          DCD     &000000c8, &55580200, &00025555
          DCD     &000000d0, &55580000, &0009556a
          DCD     &000000d8, &95580000, &00095580
          DCD     &000000e0, &95580000, &00025600
          DCD     &000000e8, &95580000, &0000a800
          DCD     &000000f0, &2aa00000, &00000000
          DCD     &000000f8, &00000000, &00000000
          DCD     -1
          ; frame 4
          DCD     &00000000, &00000000, &00000080
          DCD     &00000008, &00a80000, &00000a60
          DCD     &00000010, &02560000, &00002558
          DCD     &00000018, &09558000, &00009558
          DCD     &00000020, &25558000, &00009556
          DCD     &00000028, &a5558000, &00002555
          DCD     &00000030, &55560000, &00002555
          DCD     &00000038, &55560000, &02a02555
          DCD     &00000040, &55560aa0, &095a9555
          DCD     &00000048, &5555a558, &09555555
          DCD     &00000050, &a9555558, &2555556a
          DCD     &00000058, &02555558, &25555580
          DCD     &00000060, &00955558, &09555600
          DCD     &00000068, &00255560, &02955800
          DCD     &00000070, &00255680, &00255800
          DCD     &00000078, &00255800, &00255800
          DCD     &00000080, &00255800, &00a55800
          DCD     &00000088, &00255600, &0a555800
          DCD     &00000090, &00255580, &25555600
          DCD     &00000098, &02955560, &25555580
          DCD     &000000a0, &09555558, &25555568
          DCD     &000000a8, &a5555558, &25555556
          DCD     &000000b0, &55555560, &09aa9555
          DCD     &000000b8, &5556a960, &02009555
          DCD     &000000c0, &55580280, &00009555
          DCD     &000000c8, &55580000, &00009555
          DCD     &000000d0, &95560000, &0002555a
          DCD     &000000d8, &25560000, &00025560
          DCD     &000000e0, &25560000, &00009560
          DCD     &000000e8, &09580000, &00002580
          DCD     &000000f0, &02a00000, &00000a00
          DCD     -1
          ; frame 5
          DCD     &00000000, &02000000, &00000000
          DCD     &00000008, &09a80000, &00000a00
          DCD     &00000010, &09560000, &0000a580
          DCD     &00000018, &25560000, &00025560
          DCD     &00000020, &95560000, &00025558
          DCD     &00000028, &95580000, &00009556
          DCD     &00000030, &55580000, &00009555
          DCD     &00000038, &55580a80, &00009555
          DCD     &00000040, &5556a560, &02a89555
          DCD     &00000048, &55555560, &09565555
          DCD     &00000060, &00955560, &25555600
          DCD     &00000068, &00255680, &09555800
          DCD     &00000070, &00255800, &02955800
          DCD     &00000080, &00255600, &00255800
          DCD     &00000088, &002555a0, &00a55800
          DCD     &00000090, &00955558, &02555600
          DCD     &00000098, &02555558, &09555580
          DCD     &000000a0, &2a555558, &25555560
          DCD     &000000a8, &95555558, &2555555a
          DCD     &000000b0, &5555aa60, &09555555
          DCD     &000000b8, &55560080, &026aa555
          DCD     &000000c0, &55560000, &00802555
          DCD     &000000c8, &55560000, &00002555
          DCD     &000000d0, &a5558000, &00002556
          DCD     &000000d8, &09558000, &00009556
          DCD     &000000e0, &09558000, &00009558
          DCD     &000000e8, &025a0000, &00002560
          DCD     &000000f0, &00a00000, &00000a80
          DCD     -1
          ; frame 6
          DCD     &00000000, &0a000000, &00000000
          DCD     &00000008, &25a00000, &00002800
          DCD     &00000010, &95580000, &00009600
          DCD     &00000018, &95580000, &00025580
          DCD     &00000020, &55580000, &00095562
          DCD     &00000028, &55580000, &0009556a
          DCD     &00000030, &55600a00, &00025555
          DCD     &00000038, &555aa580, &00025555
          DCD     &00000040, &55555560, &00009555
          DCD     &00000048, &55555558, &0aaa5555
          DCD     &00000050, &a9555560, &2555556a
          DCD     &00000058, &02555580, &25555580
          DCD     &00000060, &00955600, &25555600
          DCD     &00000068, &00255800, &95555600
          DCD     &00000070, &00255800, &29555800
          DCD     &00000078, &00255a00, &02955800
          DCD     &00000080, &002555a0, &00255800
          DCD     &00000088, &00255558, &00255800
          DCD     &00000090, &00955556, &00255600
          DCD     &00000098, &02555558, &02955680
          DCD     &000000a0, &2a555558, &09555560
          DCD     &000000a8, &9555aaa0, &0955555a
          DCD     &000000b0, &55558000, &09555555
          DCD     &000000b8, &55558000, &0955a555
          DCD     &000000c0, &55558000, &026a0955
          DCD     &000000c8, &55558000, &00800955
          DCD     &000000d0, &a9556000, &00000955
          DCD     &000000d8, &82556000, &00002555
          DCD     &000000e0, &00958000, &00002556
          DCD     &000000e8, &002a0000, &00000956
          DCD     &000000f0, &00000000, &000002a8
          DCD     -1
          ; frame 7
          DCD     &00000000, &aa000000, &00000000
          DCD     &00000008, &55800000, &00000002
          DCD     &00000010, &55600000, &0000a002
          DCD     &00000018, &55600000, &000a5802
          DCD     &00000020, &55600000, &00255609
          DCD     &00000028, &55602a00, &002555a9
          DCD     &00000030, &55629580, &00095555
          DCD     &00000038, &55595580, &00095555
          DCD     &00000040, &55555560, &00025555
          DCD     &00000048, &55555560, &00025555
          DCD     &00000050, &a5555580, &0aaa556a
          DCD     &00000058, &0a555600, &25555580
          DCD     &00000060, &00955800, &25555600
          DCD     &00000068, &00955800, &95555600
          DCD     &00000070, &00255a80, &95555800
          DCD     &00000078, &00255568, &25555800
          DCD     &00000080, &00255556, &0a955800
          DCD     &00000088, &00255556, &00255600
          DCD     &00000098, &02555558, &00255680
          DCD     &000000a0, &2a556aa0, &00955560
          DCD     &000000a8, &95558000, &0255555a
          DCD     &000000b8, &55556000, &09555555
          DCD     &000000c0, &55556000, &0255a955
          DCD     &000000c8, &55555800, &009a0955
          DCD     &000000d0, &6a555800, &00200955
          DCD     &000000d8, &60956000, &00000955
          DCD     &000000e0, &80258000, &00000955
          DCD     &000000e8, &800a0000, &00000255
          DCD     &000000f0, &00000000, &000000a6
          DCD     &000000f8, &00000000, &00000008
          DCD     -1
          ; frame 8
          DCD     &00000000, &a8000000, &00000002
          DCD     &00000008, &56000000, &00000009
          DCD     &00000010, &56000000, &00000009
          DCD     &00000018, &56000000, &000aa009
          DCD     &00000020, &55802800, &00255825
          DCD     &00000028, &55829600, &009556a5
          DCD     &00000030, &55a95580, &00955555
          DCD     &00000038, &55555580, &00255555
          DCD     &00000040, &55555580, &00095555
          DCD     &00000048, &55555600, &00095555
          DCD     &00000050, &a5555800, &0009555a
          DCD     &00000058, &0a555800, &0aa955a0
          DCD     &00000068, &00955a80, &95555600
          DCD     &00000070, &00255568, &95555800
          DCD     &00000078, &00255556, &95555800
          DCD     &00000080, &00255556, &25555800
          DCD     &00000088, &00255556, &0a955600
          DCD     &00000098, &00955aa8, &00095680
          DCD     &000000a0, &2a556000, &00255568
          DCD     &000000a8, &95556000, &00955556
          DCD     &000000b0, &55556000, &02555555
          DCD     &000000b8, &55555800, &02555555
          DCD     &000000c0, &55555800, &02555955
          DCD     &000000c8, &56955600, &0095a255
          DCD     &000000d0, &58255800, &002a0255
          DCD     &000000d8, &58096000, &00000255
          DCD     &000000e0, &60028000, &00000095
          DCD     &000000e8, &60000000, &00000095
          DCD     &000000f0, &80000000, &00000025
          DCD     &000000f8, &00000000, &0000000a
          DCD     -1

; Offsets into the deltas for each frame
frame_deltas
          DCD     0  ; frame 0
          DCD     388  ; frame 1
          DCD     752  ; frame 2
          DCD     1140  ; frame 3
          DCD     1516  ; frame 4
          DCD     1892  ; frame 5
          DCD     2232  ; frame 6
          DCD     2608  ; frame 7
          DCD     2972  ; frame 8

; Palette data
          = "PALD" ; marker string for the palette data
          DCD     2
palette
          DCB     0, 153, 14
          DCB     0, 0, 0
          ALIGN

; Read the period between frames
; <=  R0 = cs between frames
hourglass_getframeperiod SIGNATURE
          EXPORT  hourglass_getframeperiod
          MOV     x0, #period
          RET


; Read the size of the workspace block
; <=  R0 = size of hourglass workspace
hourglass_getwssize SIGNATURE
          EXPORT  hourglass_getwssize
          MOV     x0, #hg_workspacesize
          RET

; Initialisation function
; =>  R0 = hourglass workspace
hourglass_init SIGNATURE
          EXPORT  hourglass_init
          MOV     x12, x0
          MOV     x0, #0
          STR     w0, hg_framenum
          STR     w0, hg_percentage
          STR     w0, hg_leds
          LDR     w0, wordblock_0
          STR     w0, hg_word
          MOV     w0, #-1
          STR     w0, hg_oldpointer
          LDR     w0, wordblock_4
          ADR     x1, hg_currentdata
          LSL     w2, w1, #16                 ; move lower hard of word into the upper half
          ORR     w0, w0, w2                  ; assign the low half word of pointer data
          STR     w0, hg_word + 4
          LSR     w0, w1, #16                 ; and the high half word
          STR     w0, hg_word + 8
; no need to initialise the currentdata; it will be updated by the first frame
          RET

wordblock_0
          DCB     0                           ; define pointer shape
          DCB     3                           ; shape number (will toggle 3-4)
          DCB     (width*2+7)/8               ; width in bytes
          DCB     height                      ; height
wordblock_4
          DCB     active_x                    ; active x offset
          DCB     active_y                    ; active y offset
          DCB     0                           ; b0-7 of the address of the pointer data
          DCB     0                           ; b8-15 of address of the pointer data

; Start the hourglass
; =>  R0 = hourglass workspace
hourglass_start SIGNATURE
          EXPORT  hourglass_start
          STP     x29, x30, [sp, #-16]!
          MOV     x29, sp
          SUB     sp, sp, #16
          MOV     x12, x0
          MOV     x0, #0
          STR     w0, hg_framenum
          MOV     x0, #1
          MOV     x1, #25                     ; read pointer colour 1
          SWI     XOS_ReadPalette
          BVC     %FT10
          LDR     w2, =&81397900              ; purple if it wasn't set
10
          STR     w2, hg_oldcolours + (4 * 0)
          MOV     x0, #2
          MOV     x1, #25                     ; read pointer colour 2
          SWI     XOS_ReadPalette
          BVC     %FT20
          LDR     w2, =&66FFFF00              ; yellow if it wasn't set
20
          STR     w2, hg_oldcolours + (4 * 1)
          MOV     x0, #3
          MOV     x1, #25                     ; read pointer colour 3
          SWI     XOS_ReadPalette
          BVC     %FT30
          LDR     w2, =&00000000              ; black if it wasn't set
30
          STR     w2, hg_oldcolours + (4 * 2)
; now set the palette up for our hourglass
          MOV     x1, sp
          ADR     x2, palette
; colour 1
          MOV     x0, #1
          STRB    w0, [x1, #0]
          MOV     w0, #25                     ; set pointer colour 1
          STRB    w0, [x1, #1]
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #2]                ; red
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #3]                ; green
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #4]                ; blue
          MOV     w0, #12
          SWI     XOS_Word                    ; Set palette
; colour 2
          MOV     x0, #2
          STRB    w0, [x1, #0]
          MOV     w0, #25                     ; set pointer colour 1
          STRB    w0, [x1, #1]
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #2]                ; red
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #3]                ; green
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #4]                ; blue
          MOV     w0, #12
          SWI     XOS_Word                    ; Set palette
          MOV     x1, #127                        ; invalid pointer number to read the pointer
          MOV     x0, #106                        ; select pointer
          SWI     XOS_Byte
          BVC     %FT10
          MOV     x1, #0                          ; if there was an error, turn off
10
          STR     w1, hg_oldpointer
          ADD     sp, sp, #16
          LDP     x29, x30, [sp], #16
          MOV     x0, x12
          B       hourglass_frame                 ; exit via the first frame

; Stop the hourglass
; =>  R0 = hourglass workspace
hourglass_stop SIGNATURE
          EXPORT  hourglass_stop
          STP     x29, x30, [sp, #-16]!
          MOV     x29, sp
          SUB     sp, sp, #16
          MOV     x12, x0
          LDR     w4, hg_oldpointer               ; work out the old pointer shape
          CMP     w4, #-1                         ; is it dead?
          BEQ     %FT10                           ;   yes, so skip all stopping
          BIC     x1, x4, #127                    ; turn off the pointer whilst we change colours
          MOV     x0, #106                        ; select pointer
          SWI     XOS_Byte
; restore the palette up for old pointer
          MOV     x1, sp
; colour 1
          ADR     x2, hg_oldcolours + (4 * 0) + 1
          MOV     w0, #1
          STRB    w0, [x1, #0]
          MOV     w0, #25                         ; set pointer colour 1
          STRB    w0, [x1, #1]
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #2]                    ; red
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #3]                    ; green
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #4]                    ; blue
          MOV     w0, #12
          SWI     XOS_Word                        ; Set palette
; colour 2
          ADR     x2, hg_oldcolours + (4 * 1) + 1
          MOV     w0, #2
          STRB    w0, [x1, #0]
          MOV     w0, #25                         ; set pointer colour 1
          STRB    w0, [x1, #1]
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #2]                    ; red
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #3]                    ; green
          LDRB    w0, [x2], #1
          STRB    w0, [x1, #4]                    ; blue
          MOV     w0, #12
          SWI     XOS_Word                        ; Set palette
          MOV     x1, x4                          ; re-select the old pointer number
          MOV     x0, #106                        ; select pointer
          SWI     XOS_Byte
          MOV     x4, #-1                         ; mark as dead
          STR     x4, hg_oldpointer
10
          ADD     sp, sp, #16
          LDP     x29, x30, [sp], #16
          RET

; Frame update - sets the hourglass shape for the current frame
; =>  R0 = hourglass workspace
hourglass_frame SIGNATURE
          EXPORT  hourglass_frame
          STP     x29, x30, [sp, #-16]!
          MOV     x29, sp
          MOV     x12, x0
          LDR     w0, hg_framenum
          ADR     x1, frame_deltas
          LDR     w0, [x1, x0, LSL #2]            ; offset within deltas for this frame
          ADR     x1, deltas
          ADD     x1, x1, x0
          ADRL    x5, hg_currentdata
rowloop
          LDRSW   x3, [x1], #4                    ; r3 = currentdata offset
          CMP     x3, #-1                         ; end of the rows
          BEQ     rowend
      [ wordsperrow = 1
          LDR     w0, [x1], #4                    ; read a word
          STR     w0, [x3, x5]                    ; store into the currentdata
      ]
      [ wordsperrow = 2
          LDP     w0, w2, [x1], #8                ; read two word from rowdata
          ADD     x3, x3, x5                      ; work out the line offset
          STR     w0, [x3]                        ; store into the currentdata
          STR     w2, [x3, #4]                    ; store into the currentdata
      ]
      [ wordsperrow = 3
          LDP     w0, w2, [x1], #8                ; read two words from rowdata
          LDR     w4, [x1]                        ; read final word from rowdata
          ADD     x3, x3, x5                      ; work out the line offset
          STP     w0, w2, [x3], #8                ; store two words to currentdata
          STR     w4, [x3], #4                    ; store final word to currentdata
      ]
      [ wordsperrow = 4
          LDP     w0, w2, [x1], #8                ; read two words from rowdata
          LDP     w4, r5, [x1]                    ; read final words from rowdata
          ADD     r3, r3, r5                      ; work out the line offset
          STP     w0, w2, [x3], #8                ; store two words to currentdata
          STP     w4, w5, [x3], #4                    ; store final words to currentdata
      ]
          B       rowloop

rowend
          MOV     x0, #21                         ; Set Pointer parameters
          ADR     x1, hg_word
          SWI     XOS_Word

          LDRB    w1, hg_word + 1                 ; get the hourglass pointer number we will use
          MOV     w5, #7
          SUB     w4, w5, w1                      ; toggles 3 to 4
          STRB    w4, hg_word + 1                 ; toggles the pointer number we use next time
          MOV     x0, #106                        ; select pointer
          SWI     XOS_Byte

          LDR     w0, hg_framenum
          ADD     w0, w0, #1
          CMP     w0, #nframes
          BNE     %FT10
          MOV     w0, #0                          ; reset counter; we've cycled
10
          STR     w0, hg_framenum
          LDP     x29, x30, [sp], #16
          RET

; Frame update within an IRQ
; =>  R12 = hourglass workspace
hourglass_frame_irq SIGNATURE
          EXPORT  hourglass_frame_irq
          STP     x29, x30, [sp, #-16]!
          MOV     x29, sp
          MOV     x0, x12
          BL      hourglass_frame
          LDP     x29, x30, [sp], #16
          RET

          END
